æµ‹è¯• Node.jsï¼Œ2018
============================================================

![](https://cdn-images-1.medium.com/max/1600/1*J3lGUOAGK-XdZMXwiHcI6w.png)

è¶…è¿‡ 3 äº¿ç”¨æˆ·æ­£åœ¨ä½¿ç”¨ [Stream][4]ã€‚è¿™äº›ç”¨æˆ·å…¨éƒ½ä¾èµ–æˆ‘ä»¬çš„æ¡†æ¶ï¼Œè€Œæˆ‘ä»¬ååˆ†æ“…é•¿æµ‹è¯•è¦æ”¾åˆ°ç”Ÿäº§ç¯å¢ƒä¸­çš„ä»»ä½•ä¸œè¥¿ã€‚æˆ‘ä»¬å¤§éƒ¨åˆ†çš„ä»£ç åº“æ˜¯ç”¨ Go è¯­è¨€ç¼–å†™çš„ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†åˆ™æ˜¯ç”¨ Python ç¼–å†™ã€‚

æˆ‘ä»¬æœ€æ–°çš„å±•ç¤ºåº”ç”¨ï¼Œ[Winds 2.0][5]ï¼Œæ˜¯ç”¨ Node.js æ„å»ºçš„ï¼Œå¾ˆå¿«æˆ‘ä»¬å°±äº†è§£åˆ°æµ‹è¯• Go å’Œ Python çš„å¸¸è§„æ–¹æ³•å¹¶ä¸é€‚åˆå®ƒã€‚è€Œä¸”ï¼Œåˆ›é€ ä¸€ä¸ªå¥½çš„æµ‹è¯•å¥—ä»¶éœ€è¦ç”¨ Node.js åšå¾ˆå¤šé¢å¤–çš„å·¥ä½œï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„æ¡†æ¶æ²¡æœ‰æä¾›ä»»ä½•å†…å»ºçš„æµ‹è¯•åŠŸèƒ½ã€‚

ä¸è®ºä½ ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œè¦æ„å»ºå®Œå¥½çš„æµ‹è¯•æ¡†æ¶å¯èƒ½éƒ½éå¸¸å¤æ‚ã€‚æœ¬æ–‡æˆ‘ä»¬ä¼šå±•ç¤ºåœ¨ä½¿ç”¨ Node.js æµ‹è¯•è¿‡ç¨‹ä¸­çš„å›°éš¾éƒ¨åˆ†ï¼Œä»¥åŠæˆ‘ä»¬åœ¨ Winds 2.0 ä¸­ç”¨åˆ°çš„å„ç§å·¥å…·ï¼Œå¹¶ä¸”åœ¨ä½ è¦ç¼–å†™ä¸‹ä¸€ä¸ªæµ‹è¯•é›†åˆæ—¶ä¸ºä½ æŒ‡æ˜æ­£ç¡®çš„æ–¹å‘ã€‚

### ä¸ºä»€ä¹ˆæµ‹è¯•å¦‚æ­¤é‡è¦

æˆ‘ä»¬éƒ½å‘ç”Ÿäº§ç¯å¢ƒä¸­æ¨é€è¿‡ç³Ÿç³•çš„æäº¤ï¼Œå¹¶ä¸”ç»å†è¿‡ç»“æœã€‚ç¢°åˆ°è¿™æ ·çš„æƒ…å†µä¸æ˜¯å¥½äº‹ã€‚ç¼–å†™ä¸€ä¸ªç¨³å›ºçš„æµ‹è¯•å¥—ä»¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ˜æ™ºçš„æ£€æµ‹ï¼Œè€Œä¸”å®ƒè¿˜è®©ä½ èƒ½å¤Ÿè‡ªç”±çš„é‡æ„ä»£ç ï¼Œé‡æ„ä¹‹åçš„ä»£ç ä»ç„¶æ­£å¸¸è¿è¡Œä¼šè®©ä½ ä¿¡å¿ƒå€å¢ã€‚è¿™åœ¨ä½ åˆšåˆšå¼€å§‹ç¼–å†™ä»£ç çš„æ—¶å€™å°¤ä¸ºé‡è¦ã€‚

å¦‚æœä½ æ˜¯ä¸å›¢é˜Ÿå…±äº‹ï¼Œè¾¾åˆ°æµ‹è¯•è¦†ç›–ç‡æå…¶é‡è¦ã€‚æ²¡æœ‰å®ƒï¼Œå›¢é˜Ÿä¸­çš„å…¶ä»–å¼€å‘è€…å‡ ä¹ä¸å¯èƒ½çŸ¥é“ä»–ä»¬æ‰€åšçš„å·¥ä½œæ˜¯å¦å¯¼è‡´é‡å¤§å˜åŠ¨ï¼ˆouchï¼‰ã€‚

ç¼–å†™æµ‹è¯•åŒæ—¶ä¿ƒè¿›ä½ å’Œä½ çš„é˜Ÿå‹æŠŠä»£ç åˆ†å‰²æˆæ›´å°çš„ç‰‡æ®µã€‚è¿™è®©åˆ«äººå»ç†è§£ä½ çš„ä»£ç å’Œä¿®æ”¹ bug å˜å¾—å®¹æ˜“å¤šäº†ã€‚äº§å“æ”¶ç›Šå˜å¾—æ›´å¤§ï¼Œå› ä¸ºä½ èƒ½æ›´æ—©çš„å‘ç° bugã€‚

æœ€åï¼Œæ²¡æœ‰æµ‹è¯•ï¼Œä½ çš„åŸºæœ¬ä»£ç è¿˜ä¸å¦‚ä¸€å †çº¸ç‰‡ã€‚åŸºæœ¬ä¸èƒ½ä¿è¯ä½ çš„ä»£ç æ˜¯ç¨³å®šçš„ã€‚

### å›°éš¾çš„éƒ¨åˆ†

åœ¨æˆ‘çœ‹æ¥ï¼Œæˆ‘ä»¬åœ¨ Winds ä¸­é‡åˆ°çš„å¤§å¤šæ•°æµ‹è¯•é—®é¢˜æ˜¯ Node.js ä¸­ç‰¹æœ‰çš„ã€‚å®ƒçš„ç”Ÿæ€ç³»ç»Ÿæ€»æ˜¯åœ¨å˜å¤§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ macOSï¼Œè¿è¡Œ "brew upgrade"ï¼ˆå®‰è£…äº† homebrewï¼‰ï¼Œä½ çœ‹åˆ°ä½ ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Node.js çš„æ¦‚ç‡éå¸¸é«˜ã€‚ç”±äº Node.js è¿­ä»£é¢‘ç¹ï¼Œç›¸åº”çš„åº“ä¹Ÿç´§éšå…¶åï¼Œæƒ³è¦ä¸æœ€æ–°çš„åº“ä¿æŒåŒæ­¥éå¸¸å›°éš¾ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›è¦è®°åœ¨å¿ƒä¸Šçš„ç—›ç‚¹ï¼š

1.  åœ¨ Node.js ä¸­è¿›è¡Œæµ‹è¯•æ˜¯å›ºæ‰§åˆä¸æ˜¯å›ºæ‰§çš„ã€‚äººä»¬å¯¹äºå¦‚ä½•æ„å»ºä¸€ä¸ªæµ‹è¯•æ¶æ„ä»¥åŠå¦‚ä½•æ£€éªŒæˆåŠŸæœ‰ä¸åŒçš„çœ‹æ³•ã€‚æ²®ä¸§çš„æ˜¯è¿˜æ²¡æœ‰ä¸€ä¸ªé»„é‡‘å‡†åˆ™è§„å®šä½ åº”è¯¥å¦‚ä½•è¿›è¡Œæµ‹è¯•ã€‚

2.  æœ‰ä¸€å †æ¡†æ¶èƒ½å¤Ÿåœ¨ä½ çš„åº”ç”¨é‡Œä½¿ç”¨ã€‚ä½†æ˜¯å®ƒä»¬ä¸€èˆ¬éƒ½å¾ˆç²¾ç®€ï¼Œæ²¡æœ‰å®Œå¥½çš„é…ç½®æˆ–è€…å¯åŠ¨è¿‡ç¨‹ã€‚è¿™ä¼šå¯¼è‡´éå¸¸å¸¸è§çš„å‰¯ä½œç”¨ï¼Œè€Œä¸”è¿˜å¾ˆéš¾æ£€æµ‹åˆ°ï¼›æ‰€ä»¥ä½ ä»¬æœ€ç»ˆä¼šæƒ³è¦ä»é›¶å¼€å§‹ç¼–å†™è‡ªå·±çš„æµ‹è¯•æ‰§è¡Œå¹³å°ã€‚

3.  å‡ ä¹èƒ½ä¿è¯ä½  _éœ€è¦_ ç¼–å†™è‡ªå·±çš„æµ‹è¯•æ‰§è¡Œå¹³å°ï¼ˆé©¬ä¸Šå°±ä¼šè®²åˆ°è¿™ä¸€èŠ‚ï¼‰ã€‚

ä»¥ä¸Šåˆ—å‡ºçš„æƒ…å†µä¸æ˜¯ç†æƒ³çš„ï¼Œè€Œä¸”è¿™æ˜¯ Node.js ç¤¾åŒºåº”è¯¥å°½ç®¡å¤„ç†çš„äº‹æƒ…ã€‚å¦‚æœå…¶ä»–è¯­è¨€è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œæˆ‘è®¤ä¸ºä¹Ÿæ˜¯ä½œä¸ºå¹¿æ³›ä½¿ç”¨çš„è¯­è¨€ï¼Œ Node.js è§£å†³è¿™äº›é—®é¢˜çš„æ—¶å€™ã€‚

### ç¼–å†™ä½ è‡ªå·±çš„æµ‹è¯•æ‰§è¡Œå¹³å°

æ‰€ä»¥...ä½ å¯èƒ½ä¼šå¥½å¥‡æµ‹è¯•æ‰§è¡Œå¹³å° _æ˜¯_ ä»€ä¹ˆï¼Œå®ƒå¹¶ä¸å¤æ‚ã€‚æµ‹è¯•æ‰§è¡Œå¹³å°åœ¨æµ‹è¯•å¥—ä»¶ä¸­æ˜¯æœ€é«˜å±‚çš„å®¹å™¨ã€‚å®ƒå…è®¸ä½ æŒ‡å®šå…¨å±€é…ç½®å’Œç¯å¢ƒï¼Œè¿˜å¯ä»¥å¯¼å…¥é…ç½®ã€‚å¯èƒ½æœ‰äººè§‰å¾—åšè¿™ä¸ªå¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿæ²¡é‚£ä¹ˆå¿«å‘¢ã€‚

æˆ‘ä»¬æ‰€å­¦åˆ°çš„æ˜¯ï¼Œå°½ç®¡ç°åœ¨å°±æœ‰è¶³å¤Ÿæ•°é‡çš„æµ‹è¯•æ¡†æ¶äº†ï¼Œæ²¡æœ‰ä¸€ä¸ªå…³äº Node.js çš„æµ‹è¯•æ¡†æ¶æä¾›æ ‡å‡†çš„æ–¹å¼èƒ½æ„å»ºä½ çš„æµ‹è¯•æ‰§è¡Œå¹³å°ã€‚å¾ˆéš¾å—ï¼Œè¿™éœ€è¦å¼€å‘è€…æ¥å®Œæˆã€‚è¿™é‡Œæœ‰ä¸ªå…³äºæµ‹è¯•æ‰§è¡Œå¹³å°çš„éœ€æ±‚çš„ç®€å•æ€»ç»“ï¼š

*   èƒ½å¤ŸåŠ è½½ä¸åŒçš„é…ç½®ï¼ˆæ¯”å¦‚ï¼Œæœ¬åœ°çš„ï¼Œæµ‹è¯•çš„ï¼Œå¼€å‘çš„ï¼‰ï¼Œèƒ½å¤Ÿç¡®ä¿ä½  _æ°¸è¿œä¸ä¼š_ åŠ è½½ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒçš„é…ç½® â€”â€” ä½ èƒ½æƒ³è±¡å‡ºé‚£æ ·ä¼šå‡ºä»€ä¹ˆé—®é¢˜ã€‚

*   æ”¯æŒæ•°æ®åº“ï¼Œç”Ÿæˆç§å­æ•°æ®åº“ï¼Œäº§ç”Ÿç”¨äºæµ‹è¯•çš„æ•°æ®ã€‚å¿…é¡»è¦æ”¯æŒå¤šç§æ•°æ®åº“ï¼Œä¸è®ºæ˜¯ MySQLã€PostgreSQLã€MongoDB æˆ–è€…å…¶å®ƒä»»ä½•ä¸€ä¸ªæ•°æ®åº“ã€‚

*   èƒ½å¤ŸåŠ è½½é…ç½®ï¼ˆå¸¦æœ‰ç”¨äºå¼€å‘ç¯å¢ƒçš„ç§å­æ•°æ®çš„æ–‡ä»¶ï¼‰ã€‚

åš Winds çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€‰æ‹© Mocha ä½œä¸ºæµ‹è¯•æ‰§è¡Œå¹³å°ã€‚Mocha æä¾›äº†ç®€å•å¹¶ä¸”å¯ç¼–ç¨‹çš„æ–¹å¼ï¼Œé€šè¿‡å‘½ä»¤è¡Œå·¥å…·ï¼ˆæ•´åˆäº† Babelï¼‰æ¥è¿è¡Œ ES6 ä»£ç çš„æµ‹è¯•ã€‚

ä¸ºäº†è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬æ³¨å†Œäº†è‡ªå·±çš„ Babel æ¨¡å—å¼•å¯¼å™¨ã€‚è¿™ä¸ºæˆ‘ä»¬æä¾›äº†æ›´ç»†çš„ç²’åº¦ï¼Œæ›´å¼ºå¤§çš„æ§åˆ¶ï¼Œåœ¨ Babel è¦†ç›–æ‰ Node.js æ¨¡å—åŠ è½½è¿‡ç¨‹å‰ï¼Œå¯¹å¯¼å…¥çš„æ¨¡å—è¿›è¡Œæ§åˆ¶ï¼Œè®©æˆ‘ä»¬æœ‰æœºä¼šåœ¨æ‰€æœ‰æµ‹è¯•è¿è¡Œå‰å¯¹æ¨¡å—è¿›è¡Œæ¨¡æ‹Ÿã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº† Mocha çš„æµ‹è¯•æ‰§è¡Œå¹³å°ç‰¹æ€§ï¼Œé¢„å…ˆæŠŠç‰¹å®šçš„è¯·æ±‚èµ‹ç»™ HTTP ç®¡ç†å™¨ã€‚æˆ‘ä»¬è¿™ä¹ˆåšæ˜¯å› ä¸ºå¸¸è§„çš„åˆå§‹åŒ–ä»£ç åœ¨æµ‹è¯•ä¸­ä¸ä¼šè¿è¡Œï¼ˆæœåŠ¡å™¨äº¤äº’æ˜¯ç”¨ Chai HTTP æ’ä»¶æ¨¡æ‹Ÿçš„ï¼‰ï¼Œè¿˜è¦åšä¸€äº›å®‰å…¨æ€§æ£€æŸ¥æ¥ç¡®ä¿æˆ‘ä»¬ä¸ä¼šè¿æ¥åˆ°ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ã€‚

å°½ç®¡è¿™ä¸æ˜¯æµ‹è¯•æ‰§è¡Œå¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œæœ‰ä¸€ä¸ªå›ºå®šåŠ è½½å™¨ä¹Ÿæ˜¯æˆ‘ä»¬æµ‹è¯•å¥—ä»¶ä¸­çš„é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬è¯•éªŒè¿‡å·²æœ‰çš„è§£å†³æ–¹æ¡ˆï¼›ç„¶è€Œï¼Œæˆ‘ä»¬æœ€ç»ˆå†³å®šç¼–å†™è‡ªå·±çš„åŠ©æ‰‹ï¼Œè¿™æ ·å®ƒå°±èƒ½è´´åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚æ ¹æ®æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨ç¼–å†™é…ç½®æ—¶ï¼Œé€šè¿‡éµå¾ªç®€å•ä¸“æœ‰çš„åè®®ï¼Œæˆ‘ä»¬å°±èƒ½åŠ è½½æ•°æ®ä¾èµ–å¾ˆå¤æ‚çš„é…ç½®ã€‚

### Winds ä¸­ç”¨åˆ°çš„å·¥å…·

å°½ç®¡è¿‡ç¨‹å¾ˆå†—é•¿ï¼Œæˆ‘ä»¬è¿˜æ˜¯èƒ½å¤Ÿåˆç†ä½¿ç”¨æ¡†æ¶å’Œå·¥å…·ï¼Œä½¿å¾—é’ˆå¯¹åå° API è¿›è¡Œçš„é€‚å½“æµ‹è¯•å˜æˆç°å®ã€‚è¿™é‡Œæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨çš„å·¥å…·ï¼š

### Mocha â˜•

[Mocha][6], è¢«ç§°ä¸º â€œåœ¨ Node.js ä¸Šè¿è¡Œçš„ç‰¹æ€§ä¸°å¯Œçš„æµ‹è¯•æ¡†æ¶â€ï¼Œæ˜¯æˆ‘ä»¬å®Œæˆä»»åŠ¡çš„é¦–é€‰ã€‚æ‹¥æœ‰è¶…è¿‡ 15K çš„ starsï¼Œå¾ˆå¤šæ”¯æŒè€…å’Œè´¡çŒ®è€…ï¼Œæˆ‘ä»¬æŒ‡å®šè¿™æ˜¯æ­£ç¡®çš„æ¡†æ¶ã€‚

### Chai ğŸ¥ƒ

ç„¶åæ˜¯æˆ‘ä»¬çš„æ–­è¨€åº“ã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ€é€‚åˆé…åˆ Mocha ä½¿ç”¨çš„ â€”â€” [Chai][7]ã€‚Chai æ˜¯ä¸€ä¸ªç”¨äº Node.jsï¼Œé€‚åˆ BDD å’Œ TDD æ¨¡å¼çš„æ–­è¨€åº“ã€‚æœ‰ç®€å•çš„ APIï¼ŒChai å¾ˆå®¹æ˜“æ•´åˆè¿›æˆ‘ä»¬çš„åº”ç”¨ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿè½»æ¾åœ°æ–­è¨€å‡ºæˆ‘ä»¬ _æœŸæœ›_ ä» Winds API ä¸­è¿”å›çš„åº”è¯¥æ˜¯ä»€ä¹ˆã€‚æœ€æ£’çš„åœ°æ–¹åœ¨äºï¼Œç”¨ Chai ç¼–å†™æµ‹è¯•è®©äººè§‰å¾—å¾ˆè‡ªç„¶ã€‚è¿™æ˜¯ä¸€ä¸ªç®€çŸ­çš„ä¾‹å­ï¼š

```
describe('retrieve user', () => {
	let user;

	before(async () => {
		await loadFixture('user');
		user = await User.findOne({email: authUser.email});
		expect(user).to.not.be.null;
	});

	after(async () => {
		await User.remove().exec();
	});

	describe('valid request', () => {
		it('should return 200 and the user resource, including the email field, when retrieving the authenticated user', async () => {
			const response = await withLogin(request(api).get(`/users/${user._id}`), authUser);

			expect(response).to.have.status(200);
			expect(response.body._id).to.equal(user._id.toString());
		});

		it('should return 200 and the user resource, excluding the email field, when retrieving another user', async () => {
			const anotherUser = await User.findOne({email: 'another_user@email.com'});

			const response = await withLogin(request(api).get(`/users/${anotherUser.id}`), authUser);

			expect(response).to.have.status(200);
			expect(response.body._id).to.equal(anotherUser._id.toString());
			expect(response.body).to.not.have.an('email');
		});

	});

	describe('invalid requests', () => {

		it('should return 404 if requested user does not exist', async () => {
			const nonExistingId = '5b10e1c601e9b8702ccfb974';
			expect(await User.findOne({_id: nonExistingId})).to.be.null;

			const response = await withLogin(request(api).get(`/users/${nonExistingId}`), authUser);
			expect(response).to.have.status(404);
		});
	});

});
```

### Sinon ğŸ§™â€

æ‹¥æœ‰ä¸ä»»ä½•æµ‹è¯•æ¡†æ¶ç›¸é€‚åº”çš„èƒ½åŠ›ï¼Œ[Sinon][8] æ˜¯æ¨¡æ‹Ÿåº“çš„é¦–é€‰ã€‚è€Œä¸”ï¼Œç²¾ç®€å®‰è£…å¸¦æ¥çš„è¶…çº§æ•´æ´çš„æ•´åˆï¼Œè®© Sinon æŠŠæ¨¡æ‹Ÿè¯·æ±‚å˜æˆç®€å•çš„è¿‡ç¨‹ã€‚å®ƒçš„ç½‘ç«™æœ‰æå…¶è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå¹¶ä¸”æä¾›ç®€å•çš„æ­¥éª¤ï¼Œä¾›ä½ å°† Sinon æ•´åˆè¿›è‡ªå·±çš„æµ‹è¯•æ¡†æ¶ä¸­ã€‚

### Nock ğŸ”®

For all external HTTP requests, we useÂ [nock][9], a robust HTTP mocking library that really comes in handy when you have to communicate with a third party API (such asÂ [Streamâ€™s REST API][10]). Thereâ€™s not much to say about this little library aside from the fact that it is awesome at what it does, and thatâ€™s why we like it. Hereâ€™s a quick example of us calling ourÂ [personalization][11]Â engine for Stream:
å¯¹äºæ‰€æœ‰å¤–éƒ¨çš„ HTTP è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¨³å®šçš„ HTTP æ¨¡æ‹Ÿåº“ [nock][9]ï¼Œåœ¨ä½ è¦å’Œç¬¬ä¸‰æ–¹ API äº¤äº’æ—¶éå¸¸æ˜“ç”¨ï¼ˆæ¯”å¦‚è¯´ [Stream's REST API][10]ï¼‰ã€‚å®ƒåšçš„äº‹æƒ…éå¸¸é…·ç‚«ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å–œæ¬¢å®ƒçš„åŸå› ï¼Œé™¤æ­¤ä¹‹å¤–å…³äºè¿™ä¸ªç²¾å¦™çš„åº“æ²¡æœ‰ä»€ä¹ˆè¦å¤šè¯´çš„äº†ã€‚è¿™æ˜¯æˆ‘ä»¬çš„é€Ÿæˆç¤ºä¾‹ï¼Œè°ƒç”¨æˆ‘ä»¬åœ¨ Stream å¼•æ“ä¸­æä¾›çš„ [personalization][11]ï¼š

```
nock(config.stream.baseUrl)
	.get(/winds_article_recommendations/)
	.reply(200, { results: [{foreign_id:`article:${article.id}`}] });
```

### Mock-require ğŸ©

[mock-require][12] åº“å…è®¸ä¾èµ–å¤–éƒ¨ä»£ç ã€‚ç”¨ä¸€è¡Œä»£ç ï¼Œä½ å°±å¯ä»¥æ›¿æ¢ä¸€ä¸ªæ¨¡å—ï¼Œå¹¶ä¸”å½“ä»£ç å°è¯•å¯¼å…¥è¿™ä¸ªåº“æ—¶ï¼Œå°†ä¼šäº§ç”Ÿæ¨¡æ‹Ÿè¯·æ±‚ã€‚è¿™æ˜¯ä¸€ä¸ªå°å·§ä½†ç¨³å®šçš„åº“ï¼Œæˆ‘ä»¬è¿˜æ˜¯å®ƒçš„ç²‰ä¸ã€‚

### Istanbul ğŸ”­

[Istanbul][13] æ˜¯ JavaScript ä»£ç è¦†ç›–å·¥å…·ï¼Œåœ¨è¿è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œé€šè¿‡æ¨¡å—é’©å­è‡ªåŠ¨æ·»åŠ è¦†ç›–ç‡ï¼Œå¯ä»¥è®¡ç®—è¯­å¥ï¼Œè¡Œæ•°ï¼Œå‡½æ•°å’Œåˆ†æ”¯è¦†ç›–ç‡ã€‚å°½ç®¡æˆ‘ä»¬æœ‰ç›¸ä¼¼åŠŸèƒ½çš„ CodeCovï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰ï¼Œè¿›è¡Œæœ¬åœ°æµ‹è¯•æ—¶ï¼Œè¿™ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…·ã€‚

### æœ€ç»ˆç»“æœâ€Šâ€”â€Šè¿è¡Œæµ‹è¯•

 _æœ‰äº†è¿™äº›åº“ï¼Œè¿˜æœ‰ä¹‹å‰æè¿‡çš„æµ‹è¯•æ‰§è¡Œå¹³å°ï¼Œç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä»€ä¹ˆæ˜¯å®Œæ•´çš„æµ‹è¯•ï¼ˆä½ å¯ä»¥åœ¨  [_è¿™é‡Œ_][14] çœ‹çœ‹æˆ‘ä»¬å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼‰ï¼š_ 

```
import nock from 'nock';
import { expect, request } from 'chai';

import api from '../../src/server';
import Article from '../../src/models/article';
import config from '../../src/config';
import { dropDBs, loadFixture, withLogin } from '../utils.js';

describe('Article controller', () => {
	let article;

	before(async () => {
		await dropDBs();
		await loadFixture('initial-data', 'articles');
		article = await Article.findOne({});
		expect(article).to.not.be.null;
		expect(article.rss).to.not.be.null;
	});

	describe('get', () => {
		it('should return the right article via /articles/:articleId', async () => {
			let response = await withLogin(request(api).get(`/articles/${article.id}`));
			expect(response).to.have.status(200);
		});
	});

	describe('get parsed article', () => {
		it('should return the parsed version of the article', async () => {
			const response = await withLogin(
				request(api).get(`/articles/${article.id}`).query({ type: 'parsed' })
			);
			expect(response).to.have.status(200);
		});
	});

	describe('list', () => {
		it('should return the list of articles', async () => {
			let response = await withLogin(request(api).get('/articles'));
			expect(response).to.have.status(200);
		});
	});

	describe('list from personalization', () => {
		after(function () {
			nock.cleanAll();
		});

		it('should return the list of articles', async () => {
			nock(config.stream.baseUrl)
				.get(/winds_article_recommendations/)
				.reply(200, { results: [{foreign_id:`article:${article.id}`}] });

			const response = await withLogin(
				request(api).get('/articles').query({
					type: 'recommended',
				})
			);
			expect(response).to.have.status(200);
			expect(response.body.length).to.be.at.least(1);
			expect(response.body[0].url).to.eq(article.url);
		});
	});
});
```

### æŒç»­é›†æˆ

æœ‰å¾ˆå¤šå¯ç”¨çš„æŒç»­é›†æˆæœåŠ¡ï¼Œä½†æˆ‘ä»¬é’Ÿçˆ± [Travis CI][15]ï¼Œå› ä¸ºä»–ä»¬å’Œæˆ‘ä»¬ä¸€æ ·å–œçˆ±å¼€æºç¯å¢ƒã€‚è€ƒè™‘åˆ° Winds æ˜¯å¼€æºçš„ï¼Œå®ƒå†åˆé€‚ä¸è¿‡äº†ã€‚

æˆ‘ä»¬çš„é›†æˆéå¸¸ç®€å• â€”â€” æˆ‘ä»¬ç”¨ [.travis.yml] æ–‡ä»¶è®¾ç½®ç¯å¢ƒï¼Œé€šè¿‡ç®€å•çš„ [npm][17] å‘½ä»¤è¿›è¡Œæµ‹è¯•ã€‚æµ‹è¯•è¦†ç›–ç‡åé¦ˆç»™ Githubï¼Œåœ¨ Github ä¸Šæˆ‘ä»¬é€šè¿‡æ˜äº†çš„å›¾ç‰‡èƒ½å¤Ÿçœ‹å‡ºæˆ‘ä»¬æœ€æ–°çš„ä»£ç æˆ–è€… PR æ˜¯ä¸æ˜¯é€šè¿‡äº†æµ‹è¯•ã€‚Github é›†æˆå¾ˆæ£’ï¼Œå› ä¸ºå®ƒå¯ä»¥è‡ªåŠ¨æŸ¥è¯¢ Travis CI è·å–ç»“æœã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåœ¨ Github ä¸ŠæŸ¥çœ‹ PR ï¼ˆç»è¿‡æµ‹è¯•ï¼‰çš„ç®€å•æˆªå›¾ï¼š

![](https://cdn-images-1.medium.com/max/1600/1*DWfI0No5wZn7BBoWtJsLoA.png)

é™¤äº† Travis CIï¼Œæˆ‘ä»¬è¿˜ç”¨åˆ°äº†å«åš [CodeCov][18] çš„å·¥å…·ã€‚CodeCov å’Œ [Istanbul] å¾ˆåƒï¼Œä½†å®ƒæ˜¯ä¸ªå¯è§†åŒ–çš„å·¥å…·ï¼Œæ–¹ä¾¿æˆ‘ä»¬ æŸ¥çœ‹ä»£ç è¦†ç›–ç‡ï¼Œæ–‡ä»¶å˜åŠ¨ï¼Œè¡Œæ•°å˜åŒ–ï¼Œè¿˜æœ‰å…¶ä»–å„ç§å°ç©æ„å„¿ã€‚å°½ç®¡ä¸ç”¨ CodeCov ä¹Ÿå¯ä»¥å¯è§†åŒ–æ•°æ®ï¼Œä½†æŠŠæ‰€æœ‰ä¸œè¥¿å›Šæ‹¬åœ¨ä¸€ä¸ªåœ°æ–¹ä¹Ÿå¾ˆä¸é”™ã€‚

### æˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆ

![](https://cdn-images-1.medium.com/max/1600/1*c9uadS4Rk4oQHxf9Gl6Q3g.png)

åœ¨å¼€å‘æˆ‘ä»¬çš„æµ‹è¯•å¥—ä»¶çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ã€‚å¼€å‘æ—¶æ²¡æœ‰â€œæ­£ç¡®â€çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å†³å®šå¼€å§‹åˆ›é€ è‡ªå·±çš„æµ‹è¯•æµç¨‹ï¼Œé€šè¿‡ç†æ¸…æ¥šå¯ç”¨çš„åº“ï¼Œæ‰¾åˆ°é‚£äº›è¶³å¤Ÿæœ‰ç”¨çš„ä¸œè¥¿æ·»åŠ åˆ°æˆ‘ä»¬çš„å·¥å…·ç®±ä¸­ã€‚

æœ€ç»ˆæˆ‘ä»¬å­¦åˆ°çš„æ˜¯ï¼Œåœ¨ Node.js ä¸­è¿›è¡Œæµ‹è¯•ä¸æ˜¯å¬ä¸Šå»é‚£ä¹ˆç®€å•ã€‚è¿˜å¥½ï¼Œéšç€ Node.js æŒç»­å®Œå–„ï¼Œç¤¾åŒºå°†ä¼šèšé›†åŠ›é‡ï¼Œæ„å»ºä¸€ä¸ªåšå›ºç¨³å¥çš„åº“ï¼Œå¯ä»¥ç”¨â€œæ­£ç¡®â€çš„æ–¹å¼å¤„ç†æ‰€æœ‰å’Œæµ‹è¯•ç›¸å…³çš„ä¸œè¥¿ã€‚

ç›´åˆ°é‚£æ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šæ¥ç€ç”¨è‡ªå·±çš„æµ‹è¯•å¥—ä»¶ï¼Œä¹Ÿå°±æ˜¯å¼€æºçš„ [Winds Github repository][20]ã€‚

### å±€é™

#### åˆ›å»ºé…ç½®æ²¡æœ‰ç®€å•çš„æ–¹æ³•

æ¡†æ¶å’Œè¯­è¨€ï¼Œå°±å¦‚ Python ä¸­çš„ Djangoï¼Œæœ‰ç®€å•çš„æ–¹å¼æ¥åˆ›å»ºé…ç½®ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™äº› Django å‘½ä»¤ï¼ŒæŠŠæ•°æ®å¯¼å‡ºåˆ°æ–‡ä»¶ä¸­æ¥è‡ªåŠ¨åŒ–é…ç½®çš„åˆ›å»ºè¿‡ç¨‹ï¼š

ä»¥ä¸‹å‘½ä»¤ä¼šæŠŠæ•´ä¸ªæ•°æ®åº“å¯¼å‡ºåˆ° db.json æ–‡ä»¶ä¸­ï¼š
./manage.py dumpdata > db.json

ä»¥ä¸‹å‘½ä»¤ä»…å¯¼å‡º django ä¸­ admin.logentry è¡¨é‡Œçš„å†…å®¹ï¼š
./manage.py dumpdata admin.logentry > logentry.json

ä»¥ä¸‹å‘½ä»¤ä¼šå¯¼å‡º auth.user è¡¨ä¸­çš„å†…å®¹ï¼š
./manage.py dumpdata auth.user > user.json

Node.js é‡Œé¢æ²¡æœ‰ç®€å•çš„æ–¹å¼æ¥åˆ›å»ºé…ç½®ã€‚æˆ‘ä»¬æœ€ååšçš„äº‹æƒ…æ˜¯ç”¨ MongoDB Compass å·¥å…·å¯¼å‡ºæ•°æ®åˆ° JSON ä¸­ã€‚è¿™ç”Ÿæˆäº†ä¸é”™çš„é…ç½®ï¼Œå¦‚ä¸‹å›¾ï¼ˆä½†æ˜¯ï¼Œè¿™æ˜¯ä¸ªä¹å‘³çš„è¿‡ç¨‹ï¼Œè‚¯å®šä¼šå‡ºé”™ï¼‰ï¼š

![](https://cdn-images-1.medium.com/max/1600/1*HvXXS57rAIfBTOQ9h1HCew.png)

#### ä½¿ç”¨ Babelï¼Œæ¨¡æ‹Ÿæ¨¡å—å’Œ Mocha æµ‹è¯•æ‰§è¡Œå¹³å°æ—¶ï¼Œæ¨¡å—åŠ è½½ä¸ç›´è§‚

ä¸ºäº†æ”¯æŒå¤šç§ node ç‰ˆæœ¬ï¼Œèƒ½å¤Ÿè·å– JavaScript æ ‡å‡†çš„æœ€æ–°é™„ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ Babel æŠŠ ES6 ä»£ç è½¬æ¢æˆ ES5ã€‚Node.js æ¨¡å—ç³»ç»ŸåŸºäº CommonJS æ ‡å‡†ï¼Œè€Œ ES6 æ¨¡å—ç³»ç»Ÿä¸­æœ‰ä¸åŒçš„è¯­ä¹‰ã€‚

Babel åœ¨ Node.js æ¨¡å—ç³»ç»Ÿçš„é¡¶å±‚æ¨¡æ‹Ÿ ES6 æ¨¡å—è¯­ä¹‰ï¼Œä½†ç”±äºæˆ‘ä»¬è¦ä½¿ç”¨æ¨¡æ‹Ÿè®¿é—®æ¥ä»‹å…¥æ¨¡å—çš„åŠ è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹²çš„æ˜¯ç»å†å¥‡æ€ªçš„æ¨¡å—åŠ è½½è¾¹è§’æƒ…å†µï¼Œè¿™çœ‹ä¸Šå»å¾ˆä¸ç›´è§‚ï¼Œè€Œä¸”èƒ½å¯¼è‡´åœ¨æ•´ä¸ªä»£ç ä¸­ï¼Œå¯¼å…¥çš„ã€åˆå§‹åŒ–çš„å’Œä½¿ç”¨çš„æ¨¡å—æœ‰ä¸åŒçš„ç‰ˆæœ¬ã€‚è¿™ä½¿æµ‹è¯•æ—¶çš„æ¨¡æ‹Ÿè¿‡ç¨‹å’Œå…¨å±€çŠ¶æ€ç®¡ç†å¤æ‚åŒ–äº†ã€‚

#### åœ¨ä½¿ç”¨ ES6 æ¨¡å—æ—¶å£°æ˜çš„å‡½æ•°ï¼Œæ¨¡å—å†…éƒ¨çš„å‡½æ•°ï¼Œéƒ½æ— æ³•æ¨¡æ‹Ÿ

å½“ä¸€ä¸ªæ¨¡å—å¯¼å‡ºå¤šä¸ªå‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå‡½æ•°è°ƒç”¨äº†å…¶ä»–çš„å‡½æ•°ï¼Œå°±ä¸å¯èƒ½æ¨¡æ‹Ÿä½¿ç”¨åœ¨æ¨¡å—å†…éƒ¨çš„å‡½æ•°ã€‚åŸå› åœ¨äºå½“ä½ å¼•ç”¨ä¸€ä¸ª ES6 æ¨¡å—æ—¶ï¼Œä½ å¾—åˆ°çš„å¼•ç”¨é›†åˆå’Œæ¨¡å—å†…éƒ¨çš„æ˜¯ä¸åŒçš„ã€‚ä»»ä½•é‡æ–°ç»‘å®šå¼•ç”¨ï¼Œå°†å…¶æŒ‡å‘æ–°å€¼çš„å°è¯•éƒ½æ— æ³•çœŸæ­£å½±å“æ¨¡å—å†…éƒ¨çš„å‡½æ•°ï¼Œå†…éƒ¨å‡½æ•°ä»ç„¶ä½¿ç”¨çš„æ˜¯åŸå§‹çš„å‡½æ•°ã€‚

### æœ€åçš„æ€è€ƒ

æµ‹è¯• Node.js åº”ç”¨æ˜¯å¤æ‚çš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒçš„ç”Ÿæ€ç³»ç»Ÿæ€»åœ¨å‘å±•ã€‚æŒæ¡æœ€æ–°å’Œæœ€å¥½çš„å·¥å…·å¾ˆé‡è¦ï¼Œè¿™æ ·ä½ å°±ä¸ä¼šæ‰é˜Ÿäº†ã€‚

å¦‚ä»Šæœ‰å¾ˆå¤šè·¯å¾„è·å– JavaScript ç›¸å…³çš„æ–°é—»ï¼Œå¯¼è‡´ä¸æ—¶ä¿±è¿›å¾ˆéš¾ã€‚å…³æ³¨é‚®ä»¶æ–°é—»åˆŠç‰©å¦‚ [JavaScript Weekly][21] å’Œ [Node Weekly][22] æ˜¯è‰¯å¥½çš„å¼€å§‹ã€‚è¿˜æœ‰ï¼Œå…³æ³¨ä¸€äº›å­æ¨¡å—å¦‚ [/r/node][23] ä¹Ÿä¸é”™ã€‚å¦‚æœä½ å–œæ¬¢äº†è§£æœ€æ–°çš„è¶‹åŠ¿ï¼Œ[State of JS][24] åœ¨å¸®åŠ©å¼€å‘è€…å¯è§†åŒ–æµ‹è¯•ä¸–ç•Œçš„è¶‹åŠ¿æ–¹ä¾¿å°±åšçš„å¾ˆå¥½ã€‚

æœ€åï¼Œè¿™é‡Œæ˜¯ä¸€äº›æˆ‘å–œæ¬¢çš„åšå®¢ï¼Œæˆ‘ç»å¸¸åœ¨è¿™ä¸Šé¢å‘æ–‡ç« ï¼š

*   [Hacker Noon][1]

*   [Free Code Camp][2]

*   [Bits and Pieces][3]

è§‰å¾—æˆ‘é—æ¼äº†æŸäº›é‡è¦çš„ä¸œè¥¿ï¼Ÿåœ¨è¯„è®ºåŒºæˆ–è€… Twitter [@NickParsons][25] è®©æˆ‘çŸ¥é“ã€‚

è¿˜æœ‰ï¼Œå¦‚æœä½ æƒ³è¦äº†è§£ Streamï¼Œæˆ‘ä»¬çš„ç½‘ç«™ä¸Šæœ‰å¾ˆæ£’çš„ 5 åˆ†é’Ÿæ•™ç¨‹ã€‚ç‚¹ [è¿™é‡Œ][26] è¿›è¡ŒæŸ¥çœ‹ã€‚

--------------------------------------------------------------------------------

ä½œè€…ç®€ä»‹ï¼š

Nick Parsons

Dreamer. Doer. Engineer. Developer Evangelist https://getstream.io.

--------------------------------------------------------------------------------

via: https://hackernoon.com/testing-node-js-in-2018-10a04dd77391

ä½œè€…ï¼š[Nick Parsons][a]
è¯‘è€…ï¼š[BriFuture](https://github.com/BriFuture)
æ ¡å¯¹ï¼š[æ ¡å¯¹è€…ID](https://github.com/æ ¡å¯¹è€…ID)

æœ¬æ–‡ç”± [LCTT](https://github.com/LCTT/TranslateProject) åŸåˆ›ç¼–è¯‘ï¼Œ[Linuxä¸­å›½](https://linux.cn/) è£èª‰æ¨å‡º

[a]:https://hackernoon.com/@nparsons08?source=post_header_lockup
[1]:https://hackernoon.com/
[2]:https://medium.freecodecamp.org/
[3]:https://blog.bitsrc.io/
[4]:https://getstream.io/
[5]:https://getstream.io/winds
[6]:https://github.com/mochajs/mocha
[7]:http://www.chaijs.com/
[8]:http://sinonjs.org/
[9]:https://github.com/node-nock/nock
[10]:https://getstream.io/docs_rest/
[11]:https://getstream.io/personalization
[12]:https://github.com/boblauer/mock-require
[13]:https://github.com/gotwarlost/istanbul
[14]:https://github.com/GetStream/Winds/tree/master/api/test
[15]:https://travis-ci.org/
[16]:https://github.com/GetStream/Winds/blob/master/.travis.yml
[17]:https://www.npmjs.com/
[18]:https://codecov.io/#features
[19]:https://github.com/gotwarlost/istanbul
[20]:https://github.com/GetStream/Winds/tree/master/api/test
[21]:https://javascriptweekly.com/
[22]:https://nodeweekly.com/
[23]:https://www.reddit.com/r/node/
[24]:https://stateofjs.com/2017/testing/results/
[25]:https://twitter.com/@nickparsons
[26]:https://getstream.io/try-the-api
