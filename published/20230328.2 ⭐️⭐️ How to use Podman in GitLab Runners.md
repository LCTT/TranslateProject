[#]: subject: "How to use Podman in GitLab Runners"
[#]: via: "https://opensource.com/article/23/3/podman-gitlab-runners"
[#]: author: "Lokesh Mandvekar https://opensource.com/users/lsm5"
[#]: collector: "lkxed"
[#]: translator: "geekpi"
[#]: reviewer: "wxy"
[#]: publisher: "wxy"
[#]: url: "https://linux.cn/article-16122-1.html"

å¦‚ä½•åœ¨ GitLab æ‰§è¡Œå™¨ä¸­ä½¿ç”¨ Podman
======

![][0]

> ä½¿ç”¨ Podman å¯åŠ¨ GitLab æ‰§è¡Œå™¨æœ‰å¤šç§æ–¹æ³•ï¼Œæˆ‘åœ¨æœ¬æ–‡ä¸­æ¦‚è¿°äº†å…¶ä¸­ä¸¤ç§ã€‚

GitLab <ruby>æ‰§è¡Œå™¨<rt>Runner</rt></ruby> æ˜¯ä¸€ä¸ªä¸ GitLab CI/CD é…åˆä½¿ç”¨çš„åº”ç”¨ï¼Œå¯åœ¨ GitLab åŸºç¡€è®¾æ–½ä¸Šçš„æµæ°´çº¿ä¸­è¿è¡Œä½œä¸šã€‚å®ƒä»¬é€šå¸¸ç”¨äºåœ¨æäº¤ä»£ç åè‡ªåŠ¨ç¼–è¯‘åº”ç”¨æˆ–åœ¨ä»£ç åº“ä¸Šè¿è¡Œæµ‹è¯•ã€‚ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºåŸºäºäº‘çš„ [Git é’©å­][1]ã€‚

ä¸»è¦çš„å…¬å…± [GitLab å®ä¾‹][2] æä¾›äº†è®¸å¤šæ˜“äºè®¿é—®çš„å…±äº«æ‰§è¡Œå™¨ï¼Œå¯ä¾›ä½ åœ¨ CI æµæ°´çº¿ä¸­ä½¿ç”¨ã€‚ä½ å¯ä»¥åœ¨ GitLab ä¸Šä»“åº“çš„ <ruby>è®¾ç½®<rt>Settings</rt></ruby> -> CI/CD -> <ruby>æ‰§è¡Œå™¨<rt>Runners</rt></ruby> ä¸­æ‰¾åˆ°å…±äº«æ‰§è¡Œå™¨çš„åˆ—è¡¨ã€‚

![Display available GitLab runners in your repository's settings][3]

ä½ å¯èƒ½ä¸æƒ³ä¾èµ–å…±äº«æ‰§è¡Œå™¨ï¼Œè€Œæ˜¯é€‰æ‹©è‡ªå·±çš„æ‰§è¡Œå™¨ï¼ŒåŸå› æœ‰å¾ˆå¤šã€‚ä¾‹å¦‚ï¼Œæ§åˆ¶æ‰§è¡Œå™¨è¿è¡Œçš„åŸºç¡€è®¾æ–½ä»¥å®ç°é¢å¤–çš„å®‰å…¨æ€§å’Œ/æˆ–éšç§ã€çµæ´»çš„æ‰§è¡Œå™¨é…ç½®æˆ–åˆ†é…ç»™ä½ çš„ GitLab ç”¨æˆ·å¸æˆ·çš„æœ‰é™ CI åˆ†é’Ÿæ•°ã€‚

GitLab æ‰§è¡Œå™¨ä¾èµ–äº <ruby>[æ‰§è¡Œç¯å¢ƒ][4]<rt>executor</rt></ruby> å·¥å…·æ¥è¿è¡Œ CI ä½œä¸šã€‚æ‰§è¡Œç¯å¢ƒæœ‰è®¸å¤šé€‰é¡¹å¯ç”¨ï¼šDockerã€Kubernetesã€VirtualBox ç­‰ã€‚

é‚£ä¹ˆï¼ŒPodman ä½œä¸ºæ‰§è¡Œç¯å¢ƒå‘¢ï¼Ÿ

è‡ª [v4.2.0][5] èµ·ï¼ŒPodman å¯¹ GitLab æ‰§è¡Œå™¨æä¾›äº†åŸç”Ÿæ”¯æŒã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ Podman ä½œä¸º GitLab æ‰§è¡Œå™¨çš„ [æ‰§è¡Œç¯å¢ƒ][6] çš„ä¸¤ç§æ–¹æ³•çš„å¿«é€Ÿæµè§ˆã€‚

### Docker æ‰§è¡Œç¯å¢ƒ

ä½ å¯ä»¥åœ¨ GitLab æ‰§è¡Œå™¨ä¸­ä½¿ç”¨ Podman ä½œä¸º Docker çš„ç›´æ¥æ›¿ä»£å“ã€‚å°±æ˜¯è¿™æ ·ï¼š

æœ¬ç¤ºä¾‹ä½¿ç”¨ 2023 å¹´ 2 æœˆçš„ CentOS Stream 9 ç¯å¢ƒï¼Œä½¿ç”¨ Podman v4.4.0ã€‚å®ƒåº”è¯¥å¯ä»¥åœ¨ä»»ä½•å…·æœ‰è¶³å¤Ÿæ–°çš„ Podman çš„ RHEL/CentOS Stream/Fedora ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œã€‚æŸ¥çœ‹ [GitLab æ–‡æ¡£][7] äº†è§£å…ˆå†³æ¡ä»¶ã€‚

é¦–å…ˆï¼Œå®‰è£… Podmanï¼š

```
$ sudo dnf -y install podman
```

æ¥ä¸‹æ¥å®‰è£… **gitlab-runner** åŒ…ï¼š

```
# æ·»åŠ  GitLab æ‰§è¡Œå™¨ä»“åº“
$ curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh" | sudo bash

# å®‰è£… gitlab-runner åŒ…
$ sudo dnf -y install gitlab-runner
```

æœ€åï¼Œå…è®¸ç”¨æˆ·åœ¨æ³¨é”€åæ‰§è¡Œä»»åŠ¡ï¼š

```
$ sudo loginctl enable-linger gitlab-runner
```

#### é…ç½®å¹¶æ³¨å†Œæ‰§è¡Œå™¨

ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤é…ç½® Docker è¿è¡Œç¯å¢ƒã€‚

å®‰è£… **gitlab-runner** åŒ…ä¼šåˆ›å»ºä¸€ä¸ª **gitlab-runner** ç”¨æˆ·å¸æˆ·ï¼Œä½†ä½ éœ€è¦ root è®¿é—®æƒé™æ‰èƒ½æ“ä½œè¯¥ç”¨æˆ·å¸æˆ·ã€‚**gitlab-runner** å¯ä»¥åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œï¼Œä½†éœ€è¦ä¸€äº›æ‰‹åŠ¨å¹²é¢„æ¥è¿›è¡Œæ„å»ºå¤„ç†ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä½¿ç”¨ `sudo` åœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹è¿è¡Œå®ƒã€‚å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```
$ sudo gitlab-runner register
Runtime platform                                    arch=amd64 os=linux pid=7978 revision=d540b510 version=15.9.1
Running in system-mode.

Enter the GitLab instance URL (for example, https://gitlab.com/):
https://gitlab.com
Enter the registration token:
xxxxxxxxxxxxxxxxx
Enter a description for the runner:
[lmandvek-c9s-gitlab-runner]:
Enter tags for the runner (comma-separated):

Enter optional maintenance note for the runner:

WARNING: Support for registration tokens and runner parameters in the 'register' command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://gitlab.com/gitlab-org/gitlab/-/issues/380872
Registering runner... succeeded                     runner=GR13489419oEPYcJ8
Enter an executor: custom, docker, ssh, docker-ssh+machine, docker-ssh, parallels, shell, virtualbox, docker+machine, instance, kubernetes:
docker
Enter the default Docker image (for example, ruby:2.7):
registry.gitlab.com/rhcontainerbot/pkg-builder
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!

Configuration (with the authentication token) was saved in "/etc/gitlab-runner/config.toml"
```

ä½ å°†éœ€è¦ä¸€äº›é¢å¤–çš„é…ç½®æ‰èƒ½ä½¿ç”¨ Podmanã€‚é…ç½®æ‰§è¡Œå™¨ä¸ºæ¯ä¸ªä½œä¸šåˆ›å»ºä¸€ä¸ªç½‘ç»œã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [GitLab æ–‡æ¡£][8]ã€‚

é¦–å…ˆï¼Œå¯ç”¨ Podman ç³»ç»ŸæœåŠ¡å¹¶ä¿®æ”¹ `/etc/gitlab-runner/config.toml` ä¸­çš„ç¯å¢ƒï¼š

```
[[runners]]
    environment = ["FF_NETWORK_PER_BUILD=1"]
    [runners.docker]
        host = "unix:///run/user/1001/podman/podman.sock"
```

é‡å¯æ‰§è¡Œå™¨ä»¥å®æ–½æ›´æ”¹ï¼š

```
$ sudo gitlab-runner restart
```

éªŒè¯æ–°çš„æ‰§è¡Œå™¨åœ¨ GitLab é¡¹ç›®çš„ <ruby>è®¾ç½®<rt>Settings</rt></ruby> -> CI/CD -> <ruby>æ‰§è¡Œå™¨<rt>Runners</rt></ruby> ä¸­å¯è§ï¼š

![Restart the GitLab runner][9]

æ¥ä¸‹æ¥ï¼ŒéªŒè¯ä½ çš„ CI æµæ°´çº¿æ­£åœ¨ä½¿ç”¨æ‰§è¡Œå™¨ã€‚ä½ çš„ CI ä»»åŠ¡æ—¥å¿—å°†æåŠæ­£åœ¨ä½¿ç”¨çš„æ‰§è¡Œå™¨çš„åç§°ä»¥åŠä»»ä½•å…¶ä»–é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ æ‰§è¡Œå™¨çš„æ‰§è¡Œç¯å¢ƒçš„åŠŸèƒ½æ ‡å¿—å’Œå®¹å™¨é•œåƒã€‚

![View CI tasklogs to display the runner][10]

### Podman-in-Podmanï¼ˆpipglrï¼‰

[Chris Evich][11] åˆ›å»ºäº† [pipglr][12]ï¼Œè¿™æ˜¯ä¸€ä¸ª Podman-in-Podman è®¾ç½®ï¼Œç”¨äºä½¿ç”¨å… root çš„ Podman æ¥æ”¯æŒä½ è‡ªå·±çš„å… root çš„ GitLab æ‰§è¡Œå™¨ã€‚æ­¤æ–¹æ³•ä¸éœ€è¦å¯¹ `.gitlab-ci.yaml` é…ç½®è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå› æ­¤ä½ å¯ä»¥ç»§ç»­æŒ‰åŸæ ·ä½¿ç”¨ç°æœ‰è®¾ç½®ã€‚

ä»¥ä¸‹æ˜¯å¸®åŠ©ä½ è¿è¡Œæ­¤ç¨‹åºçš„å¿«é€Ÿè®¾ç½®æŒ‡å—ã€‚

#### é…ç½®æ­¥éª¤

å®¹å™¨é•œåƒæ˜¯ä» [pipglr Containerfile][12] è‡ªåŠ¨æ„å»ºçš„ï¼Œå› æ­¤å°†é•œåƒè®¾ç½®ä¸ºè¯¥ä»“åº“ï¼š

```
$ IMAGE="registry.gitlab.com/qontainers/pipglr:latest"
```

æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ä½ çš„ GitLab æ³¨å†Œä»¤ç‰Œåˆ›å»º Podman å¯†é’¥ï¼š

```
$ echo '<actual registration token>' | podman secret create REGISTRATION_TOKEN -
```

åˆ›å»ºä¸€ä¸ªç©ºç™½çš„ `config.toml`ï¼Œç¨åå°†åŒ…å«ä½ çš„æ‰€æœ‰æ‰§è¡Œå™¨è®¾ç½®ã€‚ä½ å¿…é¡»æ‰§è¡Œæ­¤æ­¥éª¤æ‰èƒ½ä½¿ä»¥ä¸‹ `podman container register runlabel $IMAGE` æ­¥éª¤æˆåŠŸï¼š

```
$ touch ./config.toml  # é‡è¦:æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå³ä½¿æ˜¯ç©ºçš„ã€‚
```

æ³¨å†Œä½ çš„æ‰§è¡Œå™¨ã€‚ä½ å¯ä»¥é‡å¤æ­¤æ­¥éª¤æ¥æ³¨å†Œå¤šä¸ªæ‰§è¡Œå™¨ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨å¯èƒ½ä¸åŒçš„æ ‡ç­¾æˆ–é…ç½®é€‰é¡¹é›†å¹¶è¡Œè¿è¡Œå¤šä¸ª CI ä»»åŠ¡ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚

```
$ podman container runlabel register $IMAGE
```

ä½¿ç”¨ä½ é€‰æ‹©çš„ç¼–è¾‘å™¨ç¼–è¾‘ `config.toml`ã€‚è¿™æ˜¯å¯é€‰çš„ï¼Œä½†é€šå¸¸éœ€è¦æ›´æ”¹ç”¨äºå®é™… CI ä»»åŠ¡çš„å®¹å™¨é•œåƒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé•œåƒè®¾ç½®ä¸ºï¼š`registry.fedoraproject.org/fedora:latest`ã€‚

```
$ $EDITOR ./config.toml  # if desired
```

æœ€åï¼Œé…ç½®å¯¹å·çš„è®¿é—®ã€‚å®¹å™¨å·å†…ä½¿ç”¨å¤šä¸ªç”¨æˆ·ï¼Œå› æ­¤ä½ å¿…é¡»ä¸“é—¨é…ç½®å®ƒä»¬ä»¥å…è®¸è®¿é—®ã€‚å†æ¬¡ä½¿ç”¨ `runlabel` æ¥å®Œæˆï¼š

```
$ podman container runlabel setupstorage $IMAGE

$ podman container runlabel setupcache $IMAGE
```

#### æµ‹è¯•æ‰§è¡Œå™¨

æ˜¯æ—¶å€™æ£€æŸ¥é…ç½®äº†ã€‚é¦–å…ˆå¯åŠ¨ GitLab æ‰§è¡Œå™¨å®¹å™¨ï¼š

```
$ podman container runlabel run $IMAGE
```

å…è®¸æ‰§è¡Œå™¨ç”¨æˆ·åœ¨æ³¨é”€åè¿è¡ŒæœåŠ¡ï¼š

```
$ sudo loginctl enable-linger $(id -u)
```

éªŒè¯ä½ çš„æ–°æ‰§è¡Œå™¨åœ¨ GitLab é¡¹ç›®çš„ <ruby>è®¾ç½®<rt>Settings</rt></ruby> -> CI/CD -> <ruby>æ‰§è¡Œå™¨<rt>Runners</rt></ruby> ä¸­å¯è§ï¼š

![Verify the new runner is visible][13]

æœ€åï¼ŒéªŒè¯ä½ çš„ CI æµæ°´çº¿æ­£åœ¨ä½¿ç”¨ä½ çš„æ‰§è¡Œå™¨ï¼š

![Verify the CI pipeline][14]

### æ€»ç»“

ä½¿ç”¨ Podman å¯åŠ¨ GitLab æ‰§è¡Œå™¨æœ‰å¤šç§æ–¹æ³•ï¼Œæˆ‘åœ¨æ­¤å¤„æ¦‚è¿°äº†å…¶ä¸­ä¸¤ç§ã€‚å°è¯•ä¸€ä¸‹ï¼Œç„¶åè®©æˆ‘çŸ¥é“å“ªä¸€ä¸ªæœ€é€‚åˆä½ ã€‚å¦‚æœ Docker æ‰§è¡Œç¯å¢ƒæ–¹æ³•æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·ç™»å½•å¹¶é€šè¿‡ [Podman ä¸Šæ¸¸][15] æˆ– [GitLab æ”¯æŒ][16] æäº¤é—®é¢˜ã€‚å¦‚æœ pipglr æ–¹æ³•å‡ºç°é—®é¢˜ï¼Œè¯·åœ¨ pipglr ä¸Šæ¸¸ [æäº¤é—®é¢˜][17]ã€‚

GitLab ä¸ Podman ä¸€èµ·è¿è¡Œæ„‰å¿« ğŸ™‚

*ï¼ˆé¢˜å›¾ï¼šMJ/97e0ff4d-b769-4e20-990f-8c1e89e48434ï¼‰*

--------------------------------------------------------------------------------

via: https://opensource.com/article/23/3/podman-gitlab-runners

ä½œè€…ï¼š[Lokesh Mandvekar][a]
é€‰é¢˜ï¼š[lkxed][b]
è¯‘è€…ï¼š[geekpi](https://github.com/geekpi)
æ ¡å¯¹ï¼š[wxy](https://github.com/wxy)

æœ¬æ–‡ç”± [LCTT](https://github.com/LCTT/TranslateProject) åŸåˆ›ç¼–è¯‘ï¼Œ[Linuxä¸­å›½](https://linux.cn/) è£èª‰æ¨å‡º

[a]: https://opensource.com/users/lsm5
[b]: https://github.com/lkxed/
[1]: https://www.redhat.com/sysadmin/git-hooks?intcmp=7013a000002qLH8AAM
[2]: https://gitlab.com
[3]: https://opensource.com/sites/default/files/2023-03/podman-shared-runners1.png
[4]: https://docs.gitlab.com/runner/executors/
[5]: https://github.com/containers/podman/releases/tag/v4.2.0
[6]: https://docs.gitlab.com/runner/executors/docker.html
[7]: https://docs.gitlab.com/runner/executors/docker.html#use-podman-to-run-docker-commands
[8]: https://docs.gitlab.com/runner/executors/docker.html#create-a-network-for-each-job
[9]: https://opensource.com/sites/default/files/2023-03/assigned-project-runners2.png
[10]: https://opensource.com/sites/default/files/2023-03/CI-task-logs.png
[11]: https://gitlab.com/cevich
[12]: https://gitlab.com/qontainers/pipglr
[13]: https://opensource.com/sites/default/files/2023-03/assigned-project-runners3.png
[14]: https://opensource.com/sites/default/files/2023-03/verify-CI-pipelines.png
[15]: https://github.com/containers/podman/issues/new/choose
[16]: https://about.gitlab.com/support/#contact-support
[17]: https://gitlab.com/qontainers/pipglr/-/issues/new
[0]: https://img.linux.net.cn/data/attachment/album/202308/24/093145pkr5rd2qqkmch6xv.jpg